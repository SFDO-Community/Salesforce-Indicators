<template>
    <article class="slds-card">
        <div class="slds-card__header slds-grid">
            <h2 class="slds-card__header-title">
                <span>Indicator Builder</span>
            </h2>
        </div>
        <div class="slds-card__body slds-card__body_inner">
            <div class="indicatorDetailsContainer slds-grid slds-wrap slds-gutters">
                <div class="slds-col slds-size_1-of-2">
                    <lightning-input
                            data-api-name={indicator_Label.apiName}
                            label={indicator_Label.label}
                            value={indicator_Label.value}
                            required
                            onchange={handleIndicatorFieldChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2">
                    <lightning-input
                            data-api-name="QualifiedApiName"
                            label="Indicator Item API Name"
                            value={indicator.QualifiedApiName}
                            required
                            onchange={handleIndicatorFieldChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-1">
                    <c-fsc_object-field-selector
                            required layout="horizontal"
                            object-value={indicator_sObject.value}
                            field-value={indicator_Field.value}
                            include-full-details
                            onchange={handleObjectFieldSelectorChange}>
                    </c-fsc_object-field-selector>
                </div>
                <div class="slds-col slds-size_1-of-1">
                    <lightning-textarea
                            data-api-name={indicator_Description.apiName}
                            label={indicator_Description.label}
                            value={indicator_Description.value}
                            field-level-help={indicator_Description.inlineHelpText}
                            onchange={handleIndicatorFieldChange}>
                    </lightning-textarea>
                </div>
            </div>
            <div class="slds-vertical-tabs">
                <!-- <template lwc:if={showSpinner}>
                    <lightning-spinner></lightning-spinner>
                </template> -->
                <ul class="slds-vertical-tabs__nav" role="tablist" aria-orientation="vertical">
                    <template for:each={itemVariants} for:item="variant" for:index="index">
                        <li class={variant.tabAnchorClass} title={variant.label} role="presentation" key={variant.label}
                            data-index={index} onclick={handleTabAnchorClick}>
                            <a class="slds-vertical-tabs__link slds-is-relative tabLink" href="#" role="tab"
                               tabindex="0" aria-selected="true">
                                <!-- <span class="slds-vertical-tabs__left-icon"> -->

                                <c-indicator-bundle-item icon-source={variant.iconSource}
                                                         source-value={variant.sourceValue} ind-size="x-small"
                                                         ind-foreground-color={variant.foregroundColour}
                                                         ind-background-color={variant.backgroundColour} ind-hover-text={variant.hoverText}>
                                </c-indicator-bundle-item>
                                <!-- </span> -->
                                <span class="slds-truncate" title={variant.label}>{variant.label}</span>
                                <lightning-button-icon icon-name="utility:delete" variant="bare"
                                                       class="deleteVariantButton" data-index={index}
                                                       onclick={handleVariantDeleteClick}></lightning-button-icon>
                            </a>
                        </li>
                    </template>
                    <lightning-button label="Add variant" icon-name="utility:add" variant="base" stretch
                                      onclick={handleAddVariantClick}></lightning-button>
                </ul>

                <template lwc:if={showActiveVariant}>
                    <div class="slds-vertical-tabs__content slds-show tabSet" role="tabpanel">
                        <div class="slds-grid slds-gutters">
                            <div class="slds-col slds-size_3-of-4 slds-grid slds-wrap slds-border_right">
                                <div class="variantDesign slds-col slds-size_1-of-1 slds-p-bottom_x-small">
                                    <p class="slds-text-heading_small">Variant Design</p>
                                    <lightning-input label="Indicator Label" value={activeVariant.label}
                                                     data-index={index} data-property="label"
                                                     oncommit={handleVariantPropertyChange}></lightning-input>
                                    <lightning-input label="Active" type="toggle" checked={activeVariant.isExtensionActive}
                                                     data-index={index} data-property="isExtensionActive"
                                                     onchange={handleVariantPropertyChange}
                                                     field-level-help="When enabled, this variant will be evaluated and displayed if conditions are met"></lightning-input>
                                    <lightning-combobox label="Select Icon Source" options={iconSourceOptions}
                                                        value={activeVariant.iconSource} dropdown-alignment="auto" data-index={index}
                                                        data-property="iconSource"
                                                        onchange={handleVariantPropertyChange}></lightning-combobox>
                                    <div class="iconSourceInputs">
                                        <template lwc:if={activeVariant.iconSourceIs.sldsIcon}>
                                            <c-fsc_combobox label="Select Icon" options={iconOptions} icon-size="small"
                                                            value={activeVariant.sourceValue} data-property="sourceValue"
                                                            onchange={handleVariantPropertyChange}></c-fsc_combobox>
                                            <!-- <c-icon-selector label="Select Icon" icon-name={activeVariant.sourceValue}
                                            data-index={index} data-property="sourceValue"
                                            oniconselection={handleVariantPropertyChange}></c-icon-selector> -->
                                        </template>
                                        <template lwc:elseif={activeVariant.iconSourceIs.url}>
                                            <lightning-input label="Enter URL" value={activeVariant.sourceValue}
                                                             data-index={index} data-property="sourceValue"
                                                             onchange={handleVariantPropertyChange}></lightning-input>
                                        </template>
                                        <template lwc:elseif={activeVariant.iconSourceIs.staticResource}>
                                            <lightning-input label="Select Static Resource"
                                                             value={activeVariant.sourceValue} data-index={index}
                                                             data-property="sourceValue"
                                                             onchange={handleVariantPropertyChange}></lightning-input>
                                        </template>
                                        <template lwc:elseif={activeVariant.iconSourceIs.staticText}>
                                            <lightning-input label="Enter Static Text" value={activeVariant.sourceValue}
                                                             class="slds-p-top_xxx-small" data-index={index}
                                                             data-property="sourceValue"
                                                             onchange={handleVariantPropertyChange}></lightning-input>
                                        </template>
                                        <lightning-input label="Hover Text" value={activeVariant.hoverText}
                                                         data-index={index} data-property="hoverText"
                                                         onchange={handleVariantPropertyChange}></lightning-input>
                                        <template lwc:if={activeVariant.showColourOption}>
                                            <lightning-input label="Override Colours" type="checkbox" data-index={index}
                                                             data-property="overrideColours" checked={activeVariant.overrideColours}
                                                             onchange={handleVariantPropertyChange}></lightning-input>
                                        </template>
                                        <template lwc:if={activeVariant.showColourSelectors}>
                                            <lightning-input label="Select Foreground Colour" type="color"
                                                             data-index={index} data-property="foregroundColour"
                                                             onchange={handleVariantPropertyChange}></lightning-input>
                                            <lightning-input label="Select Background Colour" type="color"
                                                             data-index={index} data-property="backgroundColour"
                                                             onchange={handleVariantPropertyChange}></lightning-input>
                                        </template>

                                    </div>
                                </div>
                                <div class="variantLogic slds-col slds-size_1-of-1 slds-p-top_x-small">
                                    <p class="slds-text-heading_small">Variant Logic</p>
                                    <lightning-combobox label="Show When Field:" options={activeWhenToDisplayOptions}
                                                        value={activeVariantWhenToDisplay} data-index={index}
                                                        data-property="whenToDisplay" onchange={handleVariantPropertyChange}
                                                        dropdown-alignment="auto"></lightning-combobox>
                                    <template lwc:if={activeVariant.filterTypeIs.text}>
                                        <lightning-input label="Contains Text" value={activeVariant.ContainsText} 
                                                        data-index={index} data-property="ContainsText" 
                                                        onchange={handleVariantPropertyChange}></lightning-input>
                                    </template>
                                    <template lwc:elseif={activeVariant.filterTypeIs.number}>
                                        <lightning-input label="Number" type="number" value={activeVariant.ContainsText}
                                                        data-index={index} data-property="ContainsText" 
                                                        onchange={handleVariantPropertyChange}></lightning-input>
                                    </template>
                                    <template lwc:elseif={activeVariant.filterTypeIs.numericRange}>
                                        <lightning-input label="Greater Than or Equal To" type="number" 
                                                        value={activeVariant.Minimum} data-index={index} 
                                                        data-property="Minimum" onchange={handleVariantPropertyChange}></lightning-input>
                                        <lightning-input label="Less Than" type="number" value={activeVariant.Maximum}
                                                        data-index={index} data-property="Maximum" 
                                                        onchange={handleVariantPropertyChange}></lightning-input>
                                    </template>
                                </div>
                            </div>
                            <div>
                                <h2 class="slds-text-heading_small slds-col">Preview</h2>
                                <div class="slds-col">
                                    <c-indicator-bundle-item icon-source={activeVariant.iconSource}
                                                             source-value={activeVariant.sourceValue} ind-size="large"
                                                             ind-foreground-color={activeVariant.foregroundColour}
                                                             ind-background-color={activeVariant.backgroundColour}
                                                             ind-hover-text={activeVariant.hoverText}>
                                    </c-indicator-bundle-item>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div class="slds-p-top_medium" style="border-top: 1px solid #dddbda;">
                <lightning-layout horizontal-align="end">
                    <lightning-button
                        label="Cancel"
                        onclick={handleCancel}>
                    </lightning-button>
                    <lightning-button
                        disabled={saveInProgress}
                        variant="brand"
                        name="Save Changes"
                        label="Save"
                        onclick={handleSaveIndicator}
                        class="slds-m-left_x-small">
                    </lightning-button>
                </lightning-layout>
                <lightning-spinner lwc:if={saveInProgress}></lightning-spinner>
            </div>
        </div>
    </article>
</template>